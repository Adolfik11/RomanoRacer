<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RomanoRacer v5.3 - Мастерская</title>
    <style>
        :root { 
            --accent: #00d2ff; --danger: #ff416c; --gold: #ffcf33; --green: #2ecc71;
            --panel-bg: rgba(10, 10, 12, 0.98);
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; user-select: none; }
        canvas { display: block; }

        /* АНИМАЦИИ ПАНЕЛЕЙ */
        .overlay { 
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; 
            z-index: 100; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }

        .panel { 
            background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.1); 
            padding: 25px; border-radius: 20px; text-align: center; width: 340px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        }
        
        .main-title { font-size: 32px; font-weight: 800; margin: 0; font-style: italic; letter-spacing: -1px; background: linear-gradient(#fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 9px; letter-spacing: 4px; color: var(--accent); margin-bottom: 20px; text-transform: uppercase; font-weight: bold; }
        
        /* ШКАЛА ОПЫТА */
        .xp-box { background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        #xp-bar { background: var(--accent); height: 100%; width: 0%; transition: 0.6s ease-out; }

        button { 
            background: #fff; color: #000; border: none; padding: 12px; 
            font-size: 11px; cursor: pointer; font-weight: 800; text-transform: uppercase; 
            border-radius: 8px; transition: 0.2s; width: 100%; margin-bottom: 6px;
        }
        button:hover:not(:disabled) { background: var(--accent); color: white; transform: scale(1.02); }
        button:active { transform: scale(0.98); }
        button:disabled { background: #222; color: #444; }

        /* ВКЛАДКИ МАГАЗИНА */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 9px; color: #666; cursor: pointer; border-radius: 7px; transition: 0.3s; font-weight: bold; }
        .tab-btn.active { background: #222; color: var(--accent); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        
        .car-selector { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #222; }
        .upgrade-row { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #222; text-align: left; }
        
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .color-opt { height: 35px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-opt.active { border-color: white; transform: scale(1.1); }

        #hud { position: absolute; top: 25px; width: 100%; display: none; justify-content: space-around; pointer-events: none; z-index: 10; font-family: monospace; font-weight: 800; }
        
        #touch-layer { position: absolute; inset: 0; pointer-events: none; display: none; }
        .t-btn { pointer-events: auto; position: absolute; width: 75px; height: 75px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="hud">
    <div id="h-m" style="color: var(--green);">$ 0</div>
    <div id="h-s">0 КМ/Ч</div>
    <div id="h-xp" style="color: var(--gold);">УРОВЕНЬ 1</div>
</div>

<div id="scr-init" class="overlay">
    <div class="panel">
        <h1 class="main-title">ROMANO RACER</h1>
        <div class="subtitle">Издание: Симулятор</div>
        <button onclick="setControls('kb')">КЛАВИАТУРА (WASD)</button>
        <button onclick="setControls('touch')" style="margin-top:10px">СЕНСОРНЫЙ ЭКРАН</button>
    </div>
</div>

<div id="scr-home" class="overlay hidden">
    <div class="panel">
        <h1 class="main-title">ROMANO RACER</h1>
        <div class="subtitle">v5.3 МЕХАНИКА И ГАРАЖ</div>
        <div style="display:flex; justify-content:space-between; font-size:10px; color:#888; margin-top:10px">
            <span>УРОВЕНЬ ВОДИТЕЛЯ: <span id="home-lvl">1</span></span>
            <span id="xp-txt">0 XP</span>
        </div>
        <div class="xp-box"><div id="xp-bar"></div></div>
        
        <button style="background:var(--accent); color:white" onclick="nav('scr-modes')">НА СТАРТ</button>
        <button onclick="nav('scr-garage')">ГАРАЖ И АВТОСАЛОН</button>
        <button onclick="nav('scr-settings')">НАСТРОЙКИ</button>
    </div>
</div>

<div id="scr-garage" class="overlay hidden">
    <div class="panel">
        <div class="tabs">
            <div id="t-shop" class="tab-btn active" onclick="switchTab('shop')">САЛОН</div>
            <div id="t-tech" class="tab-btn" onclick="switchTab('tech')">ТЮНИНГ</div>
            <div id="t-visual" class="tab-btn" onclick="switchTab('visual')">СТИЛЬ</div>
        </div>
        
        <div style="font-size:24px; color:var(--green); margin-bottom:15px; font-weight:900">$ <span id="m-val">0</span></div>

        <div id="garage-shop">
            <div class="car-selector">
                <button onclick="changeCar(-1)" style="width:40px; background:#222; color:#fff">&lt;</button>
                <div id="car-name" style="font-weight:bold; font-size:14px">STOCK S1</div>
                <button onclick="changeCar(1)" style="width:40px; background:#222; color:#fff">&gt;</button>
            </div>
            <div id="car-info" style="font-size:10px; color:#888; margin-bottom:12px; height:30px"></div>
            <button id="buy-car-btn" onclick="buyCar()" style="background:var(--green); color:white">ВЫБРАТЬ</button>
        </div>

        <div id="garage-tech" class="hidden">
            <div class="upgrade-row">
                <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px"><span>ДВИГАТЕЛЬ V8</span><span id="st-s"></span></div>
                <button id="buy-s" onclick="buyUpgrade('s')">УЛУЧШИТЬ ($500)</button>
            </div>
            <div class="upgrade-row">
                <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px"><span>ПОДВЕСКА (КОНТРОЛЬ)</span><span id="st-h"></span></div>
                <button id="buy-h" onclick="buyUpgrade('h')">УЛУЧШИТЬ ($500)</button>
            </div>
            <div class="upgrade-row">
                <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px"><span>ТУРБО-СИСТЕМА</span><span id="st-t"></span></div>
                <button id="buy-t" onclick="buyUpgrade('t')">УЛУЧШИТЬ ($800)</button>
            </div>
        </div>

        <div id="garage-visual" class="hidden">
            <div style="font-size:10px; color:#666; margin-bottom:10px">НОВЫЕ ЦВЕТА ЗА УРОВНИ</div>
            <div class="color-grid" id="color-list"></div>
        </div>
        
        <button class="back-btn" onclick="nav('scr-home')" style="margin-top:15px; background:transparent; border:1px solid #333; color:#888">НАЗАД В МЕНЮ</button>
    </div>
</div>

<div id="scr-result" class="overlay hidden">
    <div class="panel">
        <h2 id="res-title" style="font-style:italic">РЕЗУЛЬТАТ</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:20px 0">
            <div><div style="font-size:10px; color:#888">НАГРАДА</div><div id="res-money" style="font-size:20px; font-weight:bold; color:#fff">$ 0</div></div>
            <div><div style="font-size:10px; color:#888">ОПЫТ</div><div id="res-xp" style="font-size:20px; font-weight:bold; color:var(--gold)">+0 XP</div></div>
        </div>
        <button onclick="nav('scr-home')" style="background:var(--accent); color:white">В ГАРАЖ</button>
    </div>
</div>

<div id="scr-modes" class="overlay hidden"><div class="panel"><h2>РЕЖИМЫ</h2><button onclick="nav('scr-levels')" style="background:var(--accent); color:white">КАРЬЕРА (ЭТАПЫ)</button><button onclick="startGame('free')">СВОБОДНЫЕ ЗАЕЗДЫ</button><button onclick="nav('scr-home')">НАЗАД</button></div></div>
<div id="scr-levels" class="overlay hidden"><div class="panel"><h2>ЭТАПЫ КАРЬЕРЫ</h2><div id="level-list" style="display:grid; grid-template-columns: repeat(5,1fr); gap:6px; margin:20px 0"></div><button onclick="nav('scr-modes')">НАЗАД</button></div></div>
<div id="scr-settings" class="overlay hidden"><div class="panel"><h2>НАСТРОЙКИ</h2><button onclick="setControls('kb')">КЛАВИАТУРА</button><button onclick="setControls('touch')" style="margin-top:10px">СЕНСОР</button><button onclick="nav('scr-home')">НАЗАД</button></div></div>

<div id="touch-layer">
    <div class="t-btn" style="bottom:30px; left:20px" id="t-l">←</div>
    <div class="t-btn" style="bottom:30px; left:110px" id="t-r">→</div>
    <div class="t-btn" style="bottom:30px; right:20px; border-color:var(--green); color:var(--green)" id="t-w">ГАЗ</div>
    <div class="t-btn" style="bottom:120px; right:20px; border-color:var(--danger); color:var(--danger)" id="t-s">ТОРМОЗ</div>
</div>

<canvas id="c"></canvas>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    
    const Cars = [
        { id:0, name: 'COUPE S1', price: 0, weight: 1.0, topSp: 22, acc: 0.2, steer: 0.0002 },
        { id:1, name: 'MUSCLE GT', price: 5000, weight: 1.4, topSp: 28, acc: 0.25, steer: 0.00018 },
        { id:2, name: 'HYPER R', price: 15000, weight: 0.8, topSp: 42, acc: 0.4, steer: 0.0003 }
    ];

    let save = JSON.parse(localStorage.getItem('romano_v5_pro')) || { 
        money: 0, unlocked: 1, controls: null, xp: 0, lvl: 1, 
        currentCar: 0, ownedCars: [0], carStats: { 0: {h:1, s:1, t:1, color:'#ffffff'} }
    };

    function saveG() { localStorage.setItem('romano_v5_pro', JSON.stringify(save)); }

    const Colors = [
        {c:'#ffffff', l:1}, {c:'#ff416c', l:2}, {c:'#00d2ff', l:3}, 
        {c:'#ffcf33', l:4}, {c:'#2ecc71', l:5}, {c:'#9b59b6', l:6}, {c:'#111111', l:10}
    ];

    let w, h, isGo=false, mode='free', dist=0, speed=0, playerX=0, steerVel=0, entities=[], keys={}, tempCarIdx = 0;

    function nav(id) {
        document.querySelectorAll('.overlay').forEach(e => e.classList.add('hidden'));
        setTimeout(() => {
            document.getElementById(id).classList.remove('hidden');
        }, 10);
        if(id==='scr-home') updateHome();
        if(id==='scr-garage') { tempCarIdx = save.currentCar; updateGarage(); }
        if(id==='scr-levels') renderLevels();
    }

    function renderLevels() {
        const l = document.getElementById('level-list'); l.innerHTML = '';
        for(let i=1; i<=10; i++) {
            let b=document.createElement('button'); b.innerText=i; b.style.padding='10px';
            if(i>save.unlocked) b.disabled=true; else b.onclick=()=>startGame(i);
            l.appendChild(b);
        }
    }

    function updateHome() {
        document.getElementById('home-lvl').innerText = save.lvl;
        document.getElementById('xp-txt').innerText = save.xp + " XP";
        document.getElementById('xp-bar').style.width = ((save.xp % 1000) / 10) + "%";
    }

    function updateGarage() {
        const c = Cars[tempCarIdx];
        const owned = save.ownedCars.includes(tempCarIdx);
        document.getElementById('m-val').innerText = Math.floor(save.money);
        document.getElementById('car-name').innerText = c.name;
        document.getElementById('car-info').innerText = `МАКС. СКОРОСТЬ: ${c.topSp * 8} КМ/Ч | УСКОРЕНИЕ: ${Math.floor(c.acc*100)}`;
        
        const buyBtn = document.getElementById('buy-car-btn');
        if(owned) {
            buyBtn.innerText = tempCarIdx === save.currentCar ? "ВЫБРАНО" : "ВЫБРАТЬ";
            buyBtn.disabled = tempCarIdx === save.currentCar;
            buyBtn.style.background = "var(--accent)";
        } else {
            buyBtn.innerText = `КУПИТЬ ЗА $${c.price}`;
            buyBtn.disabled = save.money < c.price;
            buyBtn.style.background = "var(--green)";
        }

        const stats = save.carStats[save.currentCar];
        document.getElementById('st-h').innerText = "★".repeat(stats.h) + "☆".repeat(5-stats.h);
        document.getElementById('st-s').innerText = "★".repeat(stats.s) + "☆".repeat(5-stats.s);
        document.getElementById('st-t').innerText = "★".repeat(stats.t) + "☆".repeat(5-stats.t);
        
        document.getElementById('buy-h').disabled = (stats.h>=5 || save.money<500);
        document.getElementById('buy-s').disabled = (stats.s>=5 || save.money<500);
        document.getElementById('buy-t').disabled = (stats.t>=5 || save.money<800);

        const cl = document.getElementById('color-list'); cl.innerHTML = '';
        Colors.forEach(opt => {
            let d = document.createElement('div'); d.className = 'color-opt';
            if(save.lvl < opt.l) { d.className += ' color-locked'; d.innerText = 'L'+opt.l; } 
            else { 
                d.style.background = opt.c; 
                if(save.carStats[save.currentCar].color === opt.c) d.className += ' active'; 
                d.onclick = () => { save.carStats[save.currentCar].color = opt.c; saveG(); updateGarage(); }; 
            }
            cl.appendChild(d);
        });
    }

    function changeCar(dir) {
        tempCarIdx = (tempCarIdx + dir + Cars.length) % Cars.length;
        updateGarage();
    }

    function buyCar() {
        const c = Cars[tempCarIdx];
        if(!save.ownedCars.includes(tempCarIdx)) {
            if(save.money >= c.price) {
                save.money -= c.price;
                save.ownedCars.push(tempCarIdx);
                save.carStats[tempCarIdx] = {h:1, s:1, t:1, color:'#ffffff'};
            }
        }
        save.currentCar = tempCarIdx;
        saveG(); updateGarage();
    }

    function buyUpgrade(t) {
        let stats = save.carStats[save.currentCar];
        let cost = t === 't' ? 800 : 500;
        if(save.money >= cost) { stats[t]++; save.money -= cost; saveG(); updateGarage(); }
    }

    function switchTab(t) {
        ['shop', 'tech', 'visual'].forEach(id => document.getElementById('garage-'+id).classList.toggle('hidden', id!==t));
        ['shop', 'tech', 'visual'].forEach(id => document.getElementById('t-'+id).classList.toggle('active', id===t));
    }

    function setControls(t) { save.controls=t; saveG(); nav('scr-home'); }

    window.onkeydown=e=>keys[e.key.toLowerCase()]=true;
    window.onkeyup=e=>keys[e.key.toLowerCase()]=false;

    function startGame(m) {
        mode=m; isGo=true; dist=0; speed=10; entities=[]; playerX=0; steerVel=0;
        document.querySelectorAll('.overlay').forEach(e=>e.classList.add('hidden'));
        document.getElementById('hud').style.display='flex';
        document.getElementById('h-xp').innerText = "УРОВЕНЬ " + save.lvl;
        if(save.controls==='touch') document.getElementById('touch-layer').style.display='block';
        const b=(id,k)=>{let el=document.getElementById(id); el.ontouchstart=e=>{e.preventDefault(); keys[k]=true;}; el.ontouchend=e=>{e.preventDefault(); keys[k]=false;};};
        b('t-l','arrowleft'); b('t-r','arrowright'); b('t-w','w'); b('t-s','s');
    }

    function finish(win) {
        isGo=false; document.getElementById('hud').style.display='none'; document.getElementById('touch-layer').style.display='none';
        let exp = Math.floor(dist / 10); let prz = win ? (mode * 1000) : Math.floor(dist/5);
        save.xp += exp; save.money += prz; save.lvl = Math.floor(save.xp / 1000) + 1;
        if(win && mode === save.unlocked && save.unlocked < 10) save.unlocked++;
        saveG();
        document.getElementById('scr-result').classList.remove('hidden');
        document.getElementById('res-title').innerText = win ? "ПОБЕДА" : "АВАРИЯ";
        document.getElementById('res-title').style.color = win ? "var(--green)" : "var(--danger)";
        document.getElementById('res-money').innerText = "$ " + prz;
        document.getElementById('res-xp').innerText = "+" + exp + " XP";
    }

    function drawCar(x, y, scale, color, isPlayer=false) {
        ctx.save();
        ctx.translate(x, y);
        if(isPlayer) ctx.rotate(steerVel * 12);
        ctx.scale(scale, scale);
        
        const carId = isPlayer ? save.currentCar : 0;
        const stats = isPlayer ? save.carStats[carId] : {s:1, h:1, t:1};

        ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(-28, 6, 56, 14); // Shadow
        ctx.fillStyle = color;
        if(carId === 0) ctx.fillRect(-24, -18, 48, 28);
        if(carId === 1) ctx.fillRect(-26, -20, 52, 32);
        if(carId === 2) {
            ctx.beginPath(); ctx.moveTo(-28,-15); ctx.lineTo(28,-15); ctx.lineTo(22,12); ctx.lineTo(-22,12); ctx.fill();
        }

        if(stats.s >= 3 || carId === 2) { // Spoiler
            ctx.fillStyle = '#111'; ctx.fillRect(-25, 8, 50, 4);
        }

        ctx.fillStyle = '#181818'; ctx.fillRect(-17, -15, 34, 16);
        ctx.fillStyle = '#4488ff'; ctx.fillRect(-14, -12, 28, 8);
        ctx.fillStyle = isPlayer ? (stats.t > 3 ? '#00f2ff' : '#ff2200') : '#ffffaa';
        ctx.fillRect(-20, -19, 9, 4); ctx.fillRect(11, -19, 9, 4);
        
        ctx.restore();
    }

    function resize() { w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
    window.onresize=resize; resize();

    function loop() {
        ctx.fillStyle = '#09090b'; ctx.fillRect(0, 0, w, h);
        let hz = h * 0.5;

        if(isGo) {
            const car = Cars[save.currentCar];
            const stats = save.carStats[save.currentCar];
            let maxSp = car.topSp + (stats.s * 4) + (stats.t * 3);
            speed = Math.max(10, Math.min(speed + ((keys['w']||keys['arrowup']) ? car.acc : -0.1), maxSp));
            let steerSens = car.steer + (stats.h * 0.00006);
            if(keys['a']||keys['arrowleft']) steerVel -= steerSens;
            else if(keys['d']||keys['arrowright']) steerVel += steerSens;
            else steerVel *= 0.94;
            steerVel = Math.max(-0.015, Math.min(0.015, steerVel));
            playerX += steerVel * 0.35 * (speed/10); 
            if(playerX < -0.8) { playerX = -0.8; steerVel = 0; }
            if(playerX > 0.8) { playerX = 0.8; steerVel = 0; }
            dist += speed / 5;
            if(mode !== 'free' && dist > mode*5000) finish(true);
            document.getElementById('h-m').innerText = "$ " + Math.floor(save.money);
            document.getElementById('h-s').innerText = Math.floor(speed * 8) + " КМ/Ч";
            if(Math.random() < 0.03 + (dist/120000)) {
                entities.push({ x: Math.random()*1.4-0.7, z: 1200, s: Math.random()*8, col: Colors[Math.floor(Math.random()*Colors.length)].c });
            }
        }

        for(let i=0; i<90; i++) {
            let z = (90 - i) * 15; let offset = (dist % 60);
            let sc = 1000 / (z + offset); let nextSc = 1000 / (z - 15 + offset);
            let y1 = hz + (1 / (z + offset)) * 28000; let y2 = hz + (1 / (z - 15 + offset)) * 28000;
            let rW1 = 400 * sc, rW2 = 400 * nextSc;
            let rx1 = w/2 - playerX * sc * 1200, rx2 = w/2 - playerX * nextSc * 1200;
            ctx.fillStyle = (Math.floor((dist + z)/60) % 2) ? '#0a0a0c' : '#050506';
            ctx.fillRect(0, y1, w, y2-y1+1);
            ctx.fillStyle = (Math.floor((dist + z)/60) % 2) ? '#282828' : '#2e2e2e';
            ctx.beginPath(); ctx.moveTo(rx1-rW1,y1); ctx.lineTo(rx1+rW1,y1); ctx.lineTo(rx2+rW2,y2); ctx.lineTo(rx2-rW2,y2); ctx.fill();
        }

        entities.sort((a,b) => b.z - a.z);
        for(let i=entities.length-1; i>=0; i--) {
            let e = entities[i]; if(isGo) e.z -= (speed - e.s);
            if(e.z > 50 && e.z < 1500) {
                let sc = 1000 / e.z, ex = w/2 + (e.x - playerX) * sc * 1200, ey = hz + (1/e.z) * 28000;
                drawCar(ex, ey, sc * 0.5, e.col);
                if(isGo && e.z < 180 && e.z > 80 && Math.abs(ex - w/2) < 70) finish(false);
            }
            if(e.z < 20) entities.splice(i, 1);
        }

        if(isGo) drawCar(w/2, h-180, 3.2, save.carStats[save.currentCar].color, true);
        requestAnimationFrame(loop);
    }

    if(!save.controls) nav('scr-init'); else nav('scr-home');
    loop();
</script>
</body>
</html>
