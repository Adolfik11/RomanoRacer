<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RomanoRacer v5 - Sim Physics</title>
    <style>
        :root { 
            --accent: #00d2ff; --danger: #ff416c; --gold: #ffcf33; --green: #2ecc71;
            --panel-bg: rgba(8, 8, 10, 0.96);
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; user-select: none; }
        canvas { display: block; }

        /* UI Styles */
        .overlay { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); animation: fadeIn 0.4s ease; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .panel { 
            background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.08); 
            padding: 30px; border-radius: 16px; text-align: center; width: 340px;
            box-shadow: 0 30px 80px rgba(0,0,0,1);
        }
        
        .main-title { font-size: 36px; font-weight: 800; margin: 0; font-style: italic; letter-spacing: -2px; background: linear-gradient(#fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 9px; letter-spacing: 4px; color: var(--accent); margin-bottom: 20px; text-transform: uppercase; font-weight: bold; }
        
        /* Components */
        .xp-box { background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        #xp-bar { background: var(--accent); height: 100%; width: 0%; transition: 0.5s; }

        .btn-list { display: flex; flex-direction: column; gap: 8px; }
        button { 
            background: #e0e0e0; color: #000; border: none; padding: 12px; 
            font-size: 13px; cursor: pointer; font-weight: 700; text-transform: uppercase; 
            border-radius: 6px; transition: 0.2s; letter-spacing: 0.5px;
        }
        button:hover { background: var(--accent); color: white; transform: translateY(-2px); }
        button:disabled { background: #222; color: #444; transform: none; cursor: default; }
        .back-btn { background: transparent; color: #666; border: 1px solid #333; color: #888; margin-top: 15px; }
        .back-btn:hover { background: #222; border-color: #444; }

        /* Garage Elements */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 10px; background: #151515; color: #555; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { background: #333; color: white; border-bottom: 2px solid var(--accent); }
        
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .color-opt { height: 35px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-opt.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .color-locked { background: #111; opacity: 0.5; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #555; }

        /* HUD & Controls */
        #hud { position: absolute; top: 25px; width: 100%; display: none; justify-content: space-around; font-size: 1.1rem; font-weight: 800; pointer-events: none; z-index: 10; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; }
        
        #touch-layer { position: absolute; inset: 0; pointer-events: none; display: none; }
        .t-btn { pointer-events: auto; position: absolute; width: 80px; height: 80px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; backdrop-filter: blur(4px); }
        .t-btn:active { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="hud">
    <div id="h-m" style="color: var(--green);">$ 0</div>
    <div id="h-s">0 KM/H</div>
    <div id="h-xp" style="color: var(--gold);">LVL 1</div>
</div>

<div id="scr-init" class="overlay">
    <div class="panel">
        <h1 class="main-title">ROMANO RACER</h1>
        <div class="subtitle">Simulation Edition</div>
        <button onclick="setControls('kb')">КЛАВИАТУРА (WASD)</button>
        <button onclick="setControls('touch')" style="margin-top:10px">СЕНСОРНЫЙ ЭКРАН</button>
    </div>
</div>

<div id="scr-home" class="overlay hidden">
    <div class="panel">
        <h1 class="main-title">ROMANO RACER</h1>
        <div class="subtitle">v5.0 HEAVY PHYSICS</div>
        <div style="display:flex; justify-content:space-between; font-size:10px; color:#888; margin-top:10px">
            <span>DRIVER LVL <span id="home-lvl">1</span></span>
            <span id="xp-txt">0 XP</span>
        </div>
        <div class="xp-box"><div id="xp-bar"></div></div>
        
        <div class="btn-list">
            <button style="background:var(--accent); color:white" onclick="nav('scr-modes')">НА СТАРТ</button>
            <button onclick="nav('scr-garage')">МАСТЕРСКАЯ</button>
            <button onclick="nav('scr-settings')">НАСТРОЙКИ</button>
        </div>
    </div>
</div>

<div id="scr-garage" class="overlay hidden">
    <div class="panel">
        <div class="tabs">
            <div id="t-tech" class="tab-btn active" onclick="switchTab('tech')">МЕХАНИКА</div>
            <div id="t-visual" class="tab-btn" onclick="switchTab('visual')">ОКРАСКА</div>
        </div>
        
        <div id="garage-tech">
            <div style="font-size:24px; color:var(--green); margin-bottom:15px; font-weight:900">$ <span id="m-val">0</span></div>
            
            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #222; text-align:left">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span style="font-size:10px; color:#888">ПОДВЕСКА (ПЛАВНОСТЬ)</span>
                    <span id="st-h" style="color:var(--gold); font-size:10px"></span>
                </div>
                <button id="buy-h" onclick="buy('h')" style="width:100%; margin-top:5px; padding:8px; font-size:10px">УЛУЧШИТЬ ($500)</button>
            </div>

            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; border:1px solid #222; text-align:left">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span style="font-size:10px; color:#888">ДВИГАТЕЛЬ V8</span>
                    <span id="st-s" style="color:var(--gold); font-size:10px"></span>
                </div>
                <button id="buy-s" onclick="buy('s')" style="width:100%; margin-top:5px; padding:8px; font-size:10px">УЛУЧШИТЬ ($500)</button>
            </div>
        </div>

        <div id="garage-visual" class="hidden">
            <div style="font-size:10px; color:#666; margin-bottom:10px">НОВЫЕ ЦВЕТА ЗА УРОВНИ</div>
            <div class="color-grid" id="color-list"></div>
        </div>
        
        <button class="back-btn" onclick="nav('scr-home')" style="width:100%">НАЗАД</button>
    </div>
</div>

<div id="scr-result" class="overlay hidden">
    <div class="panel">
        <h2 id="res-title">ФИНИШ</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:20px 0">
            <div>
                <div style="font-size:10px; color:#888">НАГРАДА</div>
                <div id="res-money" style="font-size:20px; font-weight:bold; color:#fff">$ 0</div>
            </div>
            <div>
                <div style="font-size:10px; color:#888">ОПЫТ</div>
                <div id="res-xp" style="font-size:20px; font-weight:bold; color:var(--gold)">+0 XP</div>
            </div>
        </div>
        <button onclick="nav('scr-home')" style="width:100%; background:var(--accent); color:white">ПРОДОЛЖИТЬ</button>
    </div>
</div>

<div id="scr-modes" class="overlay hidden"><div class="panel"><h2>ВЫБОР РЕЖИМА</h2><div class="btn-list"><button onclick="nav('scr-levels')" style="background:var(--accent); color:white">КАРЬЕРА</button><button onclick="startGame('free')">СВОБОДНАЯ ЕЗДА</button><button class="back-btn" onclick="nav('scr-home')">НАЗАД</button></div></div></div>
<div id="scr-levels" class="overlay hidden"><div class="panel"><h2>ЭТАПЫ</h2><div class="level-grid" id="level-list" style="display:grid; grid-template-columns: repeat(5,1fr); gap:6px; margin:20px 0"></div><button class="back-btn" onclick="nav('scr-modes')">НАЗАД</button></div></div>
<div id="scr-settings" class="overlay hidden"><div class="panel"><h2>УПРАВЛЕНИЕ</h2><button onclick="setControls('kb')">КЛАВИАТУРА</button><button onclick="setControls('touch')" style="margin-top:10px">ЭКРАН</button><button class="back-btn" onclick="nav('scr-home')">НАЗАД</button></div></div>

<div id="touch-layer">
    <div class="t-btn" style="bottom:30px; left:20px" id="t-l">←</div>
    <div class="t-btn" style="bottom:30px; left:110px" id="t-r">→</div>
    <div class="t-btn" style="bottom:30px; right:20px; border-color:var(--green); color:var(--green)" id="t-w">GAS</div>
    <div class="t-btn" style="bottom:120px; right:20px; border-color:var(--danger); color:var(--danger)" id="t-s">BRK</div>
</div>

<canvas id="c"></canvas>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    
    let save = JSON.parse(localStorage.getItem('romano_v5_sim')) || { 
        money: 0, h: 1, s: 1, unlocked: 1, controls: null, xp: 0, lvl: 1, color: '#ffffff' 
    };
    function saveG() { localStorage.setItem('romano_v5_sim', JSON.stringify(save)); }

    const Colors = [
        {c:'#ffffff', l:1}, {c:'#ff416c', l:2}, {c:'#00d2ff', l:3}, 
        {c:'#ffcf33', l:4}, {c:'#2ecc71', l:5}, {c:'#9b59b6', l:6},
        {c:'#e67e22', l:8}, {c:'#111111', l:10}
    ];

    let w, h, isGo=false, mode='free', dist=0, speed=0, playerX=0, steerVel=0, entities=[], keys={};

    function nav(id) {
        document.querySelectorAll('.overlay').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id==='scr-home') updateHome();
        if(id==='scr-garage') updateGarage();
        if(id==='scr-levels') {
            const l = document.getElementById('level-list'); l.innerHTML = '';
            for(let i=1; i<=10; i++) {
                let b=document.createElement('button'); b.innerText=i; b.style.padding='10px';
                if(i>save.unlocked) b.disabled=true; else b.onclick=()=>startGame(i);
                l.appendChild(b);
            }
        }
    }

    function updateHome() {
        document.getElementById('home-lvl').innerText = save.lvl;
        document.getElementById('xp-txt').innerText = save.xp + " XP";
        document.getElementById('xp-bar').style.width = ((save.xp % 1000) / 10) + "%";
    }

    function updateGarage() {
        document.getElementById('m-val').innerText = Math.floor(save.money);
        document.getElementById('st-h').innerText = "★".repeat(save.h) + "☆".repeat(5-save.h);
        document.getElementById('st-s').innerText = "★".repeat(save.s) + "☆".repeat(5-save.s);
        document.getElementById('buy-h').disabled = (save.h>=5 || save.money<500);
        document.getElementById('buy-s').disabled = (save.s>=5 || save.money<500);
        
        const cl = document.getElementById('color-list'); cl.innerHTML = '';
        Colors.forEach(opt => {
            let d = document.createElement('div'); d.className = 'color-opt';
            if(save.lvl < opt.l) { d.className += ' color-locked'; d.innerText = 'L'+opt.l; } 
            else { d.style.background = opt.c; if(save.color === opt.c) d.className += ' active'; d.onclick = () => { save.color = opt.c; saveG(); updateGarage(); }; }
            cl.appendChild(d);
        });
    }

    function switchTab(t) {
        document.getElementById('garage-tech').classList.toggle('hidden', t!=='tech');
        document.getElementById('garage-visual').classList.toggle('hidden', t!=='visual');
        document.getElementById('t-tech').classList.toggle('active', t==='tech');
        document.getElementById('t-visual').classList.toggle('active', t==='visual');
    }

    function buy(t) { if(save.money>=500){ save[t]++; save.money-=500; saveG(); updateGarage(); } }
    function setControls(t) { save.controls=t; saveG(); nav('scr-home'); }

    window.onkeydown=e=>keys[e.key.toLowerCase()]=true;
    window.onkeyup=e=>keys[e.key.toLowerCase()]=false;

    function startGame(m) {
        mode=m; isGo=true; dist=0; speed=10; entities=[]; playerX=0; steerVel=0;
        document.querySelectorAll('.overlay').forEach(e=>e.classList.add('hidden'));
        document.getElementById('hud').style.display='flex';
        document.getElementById('h-xp').innerText = "LVL " + save.lvl;
        if(save.controls==='touch') document.getElementById('touch-layer').style.display='block';
        const b=(id,k)=>{let el=document.getElementById(id); el.ontouchstart=e=>{e.preventDefault(); keys[k]=true;}; el.ontouchend=e=>{e.preventDefault(); keys[k]=false;};};
        b('t-l','arrowleft'); b('t-r','arrowright'); b('t-w','w'); b('t-s','s');
    }

    function finish(win) {
        isGo=false; document.getElementById('hud').style.display='none'; document.getElementById('touch-layer').style.display='none';
        let exp = Math.floor(dist / 10); let prz = win ? (mode * 1000) : Math.floor(dist/5);
        save.xp += exp; save.money += prz; save.lvl = Math.floor(save.xp / 1000) + 1;
        if(win && mode === save.unlocked && save.unlocked < 10) save.unlocked++;
        saveG();
        document.getElementById('scr-result').classList.remove('hidden');
        document.getElementById('res-title').innerText = win ? "ПОБЕДА" : "АВАРИЯ";
        document.getElementById('res-title').style.color = win ? "var(--green)" : "var(--danger)";
        document.getElementById('res-money').innerText = "$ " + prz;
        document.getElementById('res-xp').innerText = "+" + exp + " XP";
    }

    function drawCar(x, y, scale, color, isPlayer=false) {
        ctx.save();
        ctx.translate(x, y);
        
        if(isPlayer) {
            // Визуальный наклон больше физического поворота
            ctx.rotate(steerVel * 12); 
        }

        ctx.scale(scale, scale);
        
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(-28, 6, 56, 14);
        // Body
        ctx.fillStyle = color; ctx.fillRect(-24, -18, 48, 28);
        ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(-24, -4, 48, 4);
        // Roof
        ctx.fillStyle = '#181818'; ctx.fillRect(-17, -15, 34, 16);
        ctx.fillStyle = '#4488ff'; ctx.fillRect(-14, -12, 28, 8); // Glass
        // Lights
        ctx.fillStyle = isPlayer ? '#ff2200' : '#ffffaa';
        ctx.fillRect(-20, -19, 9, 4); ctx.fillRect(11, -19, 9, 4);
        
        ctx.restore();
    }

    function resize() { w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
    window.onresize=resize; resize();

    function loop() {
        ctx.fillStyle = '#09090b'; ctx.fillRect(0, 0, w, h);
        let hz = h * 0.5;

        if(isGo) {
            let maxSp = (20 + save.s*6);
            speed = Math.max(10, Math.min(speed + ((keys['w']||keys['arrowup']) ? 0.2 : -0.1), maxSp));
            
            // --- НОВАЯ СУПЕР-ТЯЖЕЛАЯ ФИЗИКА (v5.0) ---
            
            // 1. Медленное накопление угла поворота (имитация вращения руля)
            let steerSens = 0.0002 + (save.h * 0.00005); 
            if(keys['a']||keys['arrowleft']) steerVel -= steerSens;
            else if(keys['d']||keys['arrowright']) steerVel += steerSens;
            else steerVel *= 0.94; // Возврат в центр
            
            // 2. Жесткое ограничение угла поворота
            steerVel = Math.max(-0.015, Math.min(0.015, steerVel));
            
            // 3. Крайне низкий коэффициент смещения (0.35 вместо 15.0)
            // При steerVel = 0.015, смещение будет ~0.005 за кадр.
            // Ширина дороги ~1.6. Итого ~300 кадров (5 сек) на полдороги, 10 сек на всю.
            playerX += steerVel * 0.35 * (speed/10); 
            
            // Ограничитель у барьера
            if(playerX < -0.8) { playerX = -0.8; steerVel = 0; }
            if(playerX > 0.8) { playerX = 0.8; steerVel = 0; }

            // ------------------------------------------
            
            dist += speed / 5;
            if(mode !== 'free' && dist > mode*5000) finish(true);
            
            document.getElementById('h-m').innerText = "$ " + Math.floor(save.money);
            document.getElementById('h-s').innerText = Math.floor(speed * 8) + " KM/H";

            if(Math.random() < 0.03 + (dist/120000)) {
                entities.push({ x: Math.random()*1.4-0.7, z: 1200, s: Math.random()*8, col: Colors[Math.floor(Math.random()*Colors.length)].c });
            }
        }

        // Road
        for(let i=0; i<90; i++) {
            let z = (90 - i) * 15;
            let offset = (dist % 60);
            let sc = 1000 / (z + offset);
            let nextSc = 1000 / (z - 15 + offset);
            let y1 = hz + (1 / (z + offset)) * 28000;
            let y2 = hz + (1 / (z - 15 + offset)) * 28000;
            let rW1 = 400 * sc, rW2 = 400 * nextSc;
            let rx1 = w/2 - playerX * sc * 1200, rx2 = w/2 - playerX * nextSc * 1200;

            ctx.fillStyle = (Math.floor((dist + z)/60) % 2) ? '#0a0a0c' : '#050506';
            ctx.fillRect(0, y1, w, y2-y1+1); // Grass
            
            ctx.fillStyle = (Math.floor((dist + z)/60) % 2) ? '#282828' : '#2e2e2e';
            ctx.beginPath(); ctx.moveTo(rx1-rW1,y1); ctx.lineTo(rx1+rW1,y1); ctx.lineTo(rx2+rW2,y2); ctx.lineTo(rx2-rW2,y2); ctx.fill(); // Road
            
            // Lines
            if(Math.floor((dist+z)/60)%2) { 
                ctx.fillStyle='rgba(255,255,255,0.15)'; 
                ctx.fillRect(rx1-4*sc,y1,8*sc,y2-y1); 
            }
        }

        // Traffic
        entities.sort((a,b) => b.z - a.z);
        for(let i=entities.length-1; i>=0; i--) {
            let e = entities[i]; if(isGo) e.z -= (speed - e.s);
            if(e.z > 50 && e.z < 1500) {
                let sc = 1000 / e.z, ex = w/2 + (e.x - playerX) * sc * 1200, ey = hz + (1/e.z) * 28000;
                drawCar(ex, ey, sc * 0.5, e.col);
                if(isGo && e.z < 180 && e.z > 80 && Math.abs(ex - w/2) < 80) finish(false);
            }
            if(e.z < 20) entities.splice(i, 1);
        }

        if(isGo) drawCar(w/2, h-180, 3.2, save.color, true);

        requestAnimationFrame(loop);
    }

    if(!save.controls) nav('scr-init'); else nav('scr-home');
    loop();
</script>
</body>
</html>
